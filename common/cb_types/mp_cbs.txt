infamy_cb = { #CB to shatter realm with high Threat
	name = CB_NAME_INFAMY_CB
	war_name = WAR_NAME_INFAMY_CB
	sprite = 7
	sort_priority = 10000
	truce_days = 3650
	is_permanent = yes
	hostile_against_others = no
	allow_whitepeace = no
	allow_distant = no
	#display_on_map = no
	#infamy_modifier = 3
	
	allowed_to_target_tributaries = yes
	
	#check_de_jure_tier = EMPEROR
	check_all_titles = no
	
	attacker_ai_victory_worth = { factor = -1 }
	attacker_ai_defeat_worth = { factor = 100 } 
	defender_ai_victory_worth = { factor = -1 }
	defender_ai_defeat_worth = { factor = 100 }
	
	battle_warscore_mult = 1.2
	att_ticking_war_score_multiplier = 0.7
	def_ticking_war_score_multiplier = 3.0
	max_attacker_occupation_score = 50
	max_attacker_battle_score = 75
	defender_unoccupied_warscore = yes
	
	can_use = {
		ROOT = {
			#ai = yes
			independent = yes
		}
		FROM = {
			infamy >= 70
			ai = no
			shares_realm_border_with = ROOT
		}
	}
	
	
	can_use_gui = {
		check_if_crusader_trigger = yes
		NOT = { any_character = { has_character_modifier = coallition_expelled_2 } }
		any_player = { NOT = { any_war = { using_cb = infamy_cb } } }
		#ROOT = {
		#	prestige = 100
		#}
		FROM = {
			OR = {
				tier = EMPEROR
				tier = KING
			}
			is_within_diplo_range = ROOT
		}
	}

	can_use_title = {
	}
	
	is_valid = {
		always = yes
	}	
	
	on_add = {
		#if = {
		#	limit = {
		#		ROOT = { ai = yes }
		#		FROM = {
		#			NOT = {
		#				any_war = {
		#					attacker = { NOT = { character = ROOT } }
		#					using_cb = infamy_cb
		#				}
		#			}
		#		}
		#	}
		#	ROOT = {
		#		spawn_unit = {
		#			owner = THIS
		#			province = capital_scope
		#			home = capital_scope
		#			
		#			match_character = FROM
		#			match_mult = 1.0
		#			
		#			troops = {
		#				knights = { 500 500 }
		#				archers = { 500 500 }
		#				light_cavalry = { 500 500 }
		#				light_infantry = { 2500 2500 }
		#				heavy_infantry = { 1000 1000 }
		#			}
		#		
		#			attrition = 1.0
		#			disband_on_peace = yes
		#		}
		#	}
		#}
		ROOT = { character_event = { id = MP.043 } }
	}
	
	on_success = {
		FROM = {
			character_event = { id = MP.051 }
			prestige = -1000
			transfer_scaled_wealth = {
				to = ROOT
				value = 5
				min = 1000
			}
		}
	}
	
	on_success_title = {
		FROM = {
			any_demesne_title = {
				limit = { 
					OR = {
						tier = EMPEROR
						tier = KING
					}
				}
				unsafe_destroy_landed_title = THIS
			}
		}
	}

	on_invalidation = {
		ROOT = {
			show_scope_change = no
			piety = 100
		}
	}

	on_fail = {
		ROOT = { prestige = -50 }
	}
	
	on_reverse_demand = {
		ROOT = {
			prestige = -1000
			add_character_modifier = {
				name = coallition_expelled_2
				years = 2
			}
			transfer_scaled_wealth = {
				to = FROM
				value = 4
				min = 1000
			}
		}
		FROM = {
			prestige = 1000
			character_event = { id = MP.050 }
		}
	}
	
	on_attacker_leader_death = { end_war = invalid } 
	
	ai_will_do = {
		factor = 1
		
		modifier = {
			factor = 10
		}
	}
}

emf_ismaili_caliphate_rising = {
	name = CB_NAME_ISMAILI_CALIPHATE_RISING
	war_name = WAR_NAME_ISMAILI_CALIPHATE_RISING
	sprite = 8
	truce_days = 365
	hostile_against_others = no
	check_de_jure_tier = KING # this scans all de jure kingdoms for the counties which are held by or vassals(or below) of selected character. Only valid if is_permanent = yes
	apply_short_occ_mod = no # Do not apply the 'recently_conquered' modifier to Holdings
	battle_warscore_mult = 1.5

	can_use = {
		emf_cb_can_use = yes
		ROOT = { has_flag = ismaili_caliphate_pretender }
	}

	is_valid = {
		ROOT = { has_flag = ismaili_caliphate_pretender }
		d_ismaili = { has_holder = no }
	}

	is_valid_title = { FROM = { any_realm_province = { de_jure_liege_or_above = PREVPREV } } }

	on_add = {
		log = "CB(emf_ismaili_caliphate_rising): START: title=[FromFrom.GetID]: [Root.EMF_GetDebugName] vs. [From.EMF_GetDebugName]"
		emf_cb_on_add = yes
	}

	on_success = {
		log = "CB(emf_ismaili_caliphate_rising): VICTORY: title=[FromFrom.GetID]: [Root.EMF_GetDebugName] vs. [From.EMF_GetDebugName]"
		clr_global_flag = ismaili_caliphate_revolt_ongoing
		emf_cb_holy_victory = yes
		emf_imperial_decay_major_victory = yes
		set_parent_religion = { religion = ismaili parent = 0 }
		ROOT = {
			piety = 500
			religion_authority = { modifier = rise_of_the_ismaili_caliphate }
			clr_flag = ismaili_caliphate_pretender
		}
		FROM = {
			piety = -500
			religion_authority = { modifier = ismaili_victorious1 }
		}
		hidden_effect = {
			set_parent_religion = { religion = qarmatian parent = ismaili }
			set_global_flag = qarmatian_activated
		}
	}

	on_success_title = {
		hidden_effect = {
			save_event_target_as = conquered_title
			ROOT = { narrative_event = { id = emf_heresy.1977 } }
		}
		emf_cb_latb = yes
		custom_tooltip = {
			text = other_invasion_succ_tip
			hidden_tooltip = {
				d_ismaili = {
					usurp_title = { target = ROOT type = holy_war }
				}
				FROM = {
					random_realm_province = {
						limit = {
							owner_under_PREV = yes
							de_jure_liege_or_above = PREVPREV
							NOT = { religion = ROOT }
							religion_group = muslim
						}
						religion = ROOT
					}
					random_realm_province = {
						limit = {
							owner_under_PREV = yes
							de_jure_liege_or_above = PREVPREV
							any_neighbor_province = { religion = ROOT }
							NOT = { religion = ROOT }
							religion_group = muslim
						}
						religion = ROOT
					}
					random_realm_province = {
						limit = {
							owner_under_PREV = yes
							de_jure_liege_or_above = PREVPREV
							any_neighbor_province = { religion = ROOT }
							NOT = { religion = ROOT }
							religion_group = muslim
						}
						religion = ROOT
					}
					random_realm_province = {
						limit = {
							owner_under_PREV = yes
							de_jure_liege_or_above = PREVPREV
							any_neighbor_province = { religion = ROOT }
							NOT = { religion = ROOT }
							religion_group = muslim
						}
						religion = ROOT
					}
					random_realm_province = {
						limit = {
							owner_under_PREV = yes
							de_jure_liege_or_above = PREVPREV
							any_neighbor_province = { religion = ROOT }
							NOT = { religion = ROOT }
							religion_group = muslim
						}
						religion = ROOT
					}
				}
				pf_liege_change_under_title_begin_effect = yes
				ROOT = {
					remove_trait = imamah_claimant
					clr_flag = is_imamah_claimant
					set_global_flag = emf_latb_upon_gain
					occupy_minors_of_occupied_settlements = FROM
					gain_all_occupied_titles = { who = FROM type = revolt }
					clr_global_flag = emf_latb_upon_gain
					vassalize_or_take_under_title_destroy_duchies = {
						title = PREV
						enemy = FROM
						is_religious = yes
						same_religion = yes
						type = revolt
					}
					character_event = { id = emf_cb.10 days = 1 }
					usurp_title = { target = PREV type = revolt }
				}
				pf_liege_change_under_title_end_effect = yes
				if = {
					limit = { FROM = { is_liege_or_above = ROOT } }
					FROM = { imprison = ROOT }
				}
			}
		}
	}

	on_success_posttitle = { emf_cb_on_success_posttitle = yes }

	on_fail = {
		log = "CB(emf_ismaili_caliphate_rising): WHITEPEACE: title=[FromFrom.GetID]: [Root.EMF_GetDebugName] vs. [From.EMF_GetDebugName]"
		clr_global_flag = ismaili_caliphate_revolt_ongoing
		FROM = { piety = 250 }
		ROOT = {
			piety = -250
			clr_flag = ismaili_caliphate_pretender
		}
	}

	on_reverse_demand = {
		log = "CB(emf_ismaili_caliphate_rising): DEFEAT: title=[FromFrom.GetID]: [Root.EMF_GetDebugName] vs. [From.EMF_GetDebugName]"
		clr_global_flag = ismaili_caliphate_revolt_ongoing
		emf_cb_holy_defeat = yes
		emf_imperial_decay_major_loss = yes
		ROOT = {
			piety = -500
			clr_flag = ismaili_caliphate_pretender
			imprison = FROM
		}
		FROM = { piety = 250 }
		any_defender = {
			limit = { character = FROM }
			participation_scaled_piety = 250
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_piety = 250 }
		}
	}

	on_attacker_leader_death = {
		clr_global_flag = ismaili_caliphate_revolt_ongoing
		clr_global_flag = ismaili_caliphate_revolt
		ROOT = { clr_flag = ismaili_caliphate_pretender }
		end_war = invalid
	}

	on_invalidation = {
		log = "CB(emf_ismaili_caliphate_rising): INVALIDATED: [Root.EMF_GetDebugName] vs. [From.EMF_GetDebugName]"
		clr_global_flag = ismaili_caliphate_revolt_ongoing
		clr_global_flag = ismaili_caliphate_revolt
		ROOT = { clr_flag = ismaili_caliphate_pretender }
	}

	attacker_ai_victory_worth = {
		factor = -1
	}

	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}

	defender_ai_defeat_worth = {
		factor = 100
	}
}

nomad_succession_cb = { #CB to shatter realm with high Threat
	name = CB_NAME_NOMAD_SUC_CB
	war_name = WAR_NAME_NOMAD_SUC_CB
	sprite = 7
	sort_priority = 100000
	truce_days = 3650
	is_permanent = no
	hostile_against_others = no
	
	can_call_allies = no
	defender_can_call_allies = no
	can_call_vassals = no
	
	allow_whitepeace = no
	allow_distant = no
	#display_on_map = no
	#infamy_modifier = 3
	
	allowed_to_target_tributaries = yes
	
	#check_de_jure_tier = EMPEROR
	check_all_titles = no
	
	attacker_ai_victory_worth = { factor = -1 }
	attacker_ai_defeat_worth = { factor = 100 } 
	defender_ai_victory_worth = { factor = -1 }
	defender_ai_defeat_worth = { factor = 100 }
	
	battle_warscore_mult = 1.2
	att_ticking_war_score_multiplier = 0.7
	def_ticking_war_score_multiplier = 3.0
	max_attacker_occupation_score = 50
	max_attacker_battle_score = 75
	defender_unoccupied_warscore = yes
	
	#can_use = {
	#	FROM = {
	#		infamy >= 60
	#	}
	#}
	
	
	#can_use_gui = {
	#	check_if_crusader_trigger = yes
	#	#ROOT = {
	#	#	prestige = 100
	#	#}
	#	FROM = { 
	#		OR = {
	#			tier = EMPEROR
	#			tier = KING
	#		}
	#	}
	#}

	#can_use_title = {
	#	location = {
	#		any_neighbor_province = {
	#			owner = {
	#				OR = {
	#					character = ROOT
	#					is_liege_or_above = ROOT
	#				}
	#			}
	#		}
	#	}
	#}
	
	is_valid = {
		always = yes
	}
	
	on_add = {
		#if = {
		#	limit = {
		#		ROOT = { ai = yes }
		#		FROM = {
		#			NOT = {
		#				any_war = {
		#					attacker = { NOT = { character = ROOT } }
		#					using_cb = infamy_cb
		#				}
		#			}
		#		}
		#	}
		#	ROOT = {
		#		spawn_unit = {
		#			owner = THIS
		#			province = capital_scope
		#			home = capital_scope
		#			
		#			match_character = FROM
		#			match_mult = 1.0
		#			
		#			troops = {
		#				knights = { 500 500 }
		#				archers = { 500 500 }
		#				light_cavalry = { 500 500 }
		#				light_infantry = { 2500 2500 }
		#				heavy_infantry = { 1000 1000 }
		#			}
		#		
		#			attrition = 1.0
		#			disband_on_peace = yes
		#		}
		#	}
		#}
		#ROOT = { character_event = { id = MP.043 } }
	}
	
	on_success = {
	}
	
	on_success_title = {
		custom_tooltip = {
			text = warning_revolting_clan
			FROM = {
				any_demesne_title = {
					limit = { 
						OR = {
							tier = EMPEROR
							tier = KING
						}
					}
					unsafe_destroy_landed_title = THIS
				}
			}
		}
	}

	on_invalidation = {
		ROOT = {
			any_demesne_title = {
				unsafe_destroy_landed_title = THIS
			}
			death = {
				death_reason = death_missing
			}
			clear_wealth = yes
		}
	}

	on_fail = {
		ROOT = {
			any_demesne_title = {
				unsafe_destroy_landed_title = THIS
			}
			death = {
				death_reason = death_missing
			}
			clear_wealth = yes
		}
	}
	
	on_reverse_demand = {
		FROM = {
			prestige = 150
		}
		ROOT = {
			any_demesne_title = {
				unsafe_destroy_landed_title = THIS
			}
			death = {
				death_reason = death_missing
			}
			clear_wealth = yes
		}
	}
	
	on_attacker_leader_death = { end_war = invalid } 
	
	ai_will_do = {
		factor = 1
		
		modifier = {
			factor = 100
		}
	}
}

overextention_cb = { #CB to shatter realm with a too big realm
	name = CB_NAME_OVEREXTENTION_CB
	war_name = WAR_NAME_OVEREXTENTION_CB
	sprite = 7
	sort_priority = 100000
	truce_days = 3650
	is_permanent = yes
	hostile_against_others = no
	allow_whitepeace = no
	allow_distant = no
	#display_on_map = no
	#infamy_modifier = 3
	
	allowed_to_target_tributaries = yes
	
	#check_de_jure_tier = EMPEROR
	check_all_titles = no
	
	attacker_ai_victory_worth = { factor = -1 }
	attacker_ai_defeat_worth = { factor = 100 } 
	defender_ai_victory_worth = { factor = -1 }
	defender_ai_defeat_worth = { factor = 100 }
	
	battle_warscore_mult = 1.2
	att_ticking_war_score_multiplier = 0.7
	def_ticking_war_score_multiplier = 3.0
	max_attacker_occupation_score = 50
	max_attacker_battle_score = 75
	defender_unoccupied_warscore = yes
	
	can_use = {
		ROOT = {
			independent = yes
		}
		FROM = {
			#realm_size >= 1200
			#ai = no
			OR = {
				has_character_modifier = realm_nerf_8
				has_character_modifier = realm_nerf_7
				has_character_modifier = realm_nerf_6
			}
			shares_realm_border_with = ROOT
		}
	}
	
	
	can_use_gui = {
		check_if_crusader_trigger = yes
		any_player = { NOT = { any_war = { using_cb = overextention_cb } } }
		any_player = { NOT = { has_character_modifier = coallition_expelled } }
		#ROOT = {
		#	prestige = 100
		#}
		FROM = {
			OR = {
				tier = EMPEROR
				tier = KING
			}
			is_within_diplo_range = ROOT
		}
	}

	can_use_title = {
	}
	
	is_valid = {
		always = yes
	}	
	
	on_add = {
		#if = {
		#	limit = {
		#		ROOT = { ai = yes }
		#		FROM = {
		#			NOT = {
		#				any_war = {
		#					attacker = { NOT = { character = ROOT } }
		#					using_cb = infamy_cb
		#				}
		#			}
		#		}
		#	}
		#	ROOT = {
		#		spawn_unit = {
		#			owner = THIS
		#			province = capital_scope
		#			home = capital_scope
		#			
		#			match_character = FROM
		#			match_mult = 1.0
		#			
		#			troops = {
		#				knights = { 500 500 }
		#				archers = { 500 500 }
		#				light_cavalry = { 500 500 }
		#				light_infantry = { 2500 2500 }
		#				heavy_infantry = { 1000 1000 }
		#			}
		#		
		#			attrition = 1.0
		#			disband_on_peace = yes
		#		}
		#	}
		#}
		#ROOT = { character_event = { id = MP.043 } }
	}
	
	on_success = {
		FROM = {
			character_event = { id = MP.051 }
			prestige = -1000
			transfer_scaled_wealth = {
				to = ROOT
				value = 3	
				min = 1000
				max = 5000
			}
		}
	}
	
	on_success_title = {
		FROM = {
			any_demesne_title = {
				limit = { 
					OR = {
						tier = EMPEROR
						tier = KING
					}
				}
				unsafe_destroy_landed_title = THIS
			}
		}
	}

	on_invalidation = {
		ROOT = {
			show_scope_change = no
			piety = 100
		}
	}

	on_fail = {
		ROOT = { prestige = -50 }
	}
	
	on_reverse_demand = {
		ROOT = {
			prestige = -1000
			add_character_modifier = {
				name = coallition_expelled
				years = 1
			}
			transfer_scaled_wealth = {
				to = FROM
				value = 3
				min = 1000
				max = 5000
			}
		}
		FROM = {
			prestige = 1000
			#disband_event_forces = yes
			#character_event = { id = MP.050 }
		}
	}
	
	on_attacker_leader_death = { end_war = invalid } 
	
	ai_will_do = {
		factor = 0
		
		#modifier = {
		#	factor = 100
		#}
	}
}


migration_cb = { #CB to shatter realm with a too big realm
	name = CB_NAME_MIGRATION_CB
	war_name = WAR_NAME_MIGRATION_CB
	sort_priority = 100000
	sprite = 8
	truce_days = 3650
	hostile_against_others = yes
	is_permanent = yes
	can_ask_to_join_war = no
	max_attacker_battle_score = 50 # Limit warscore from battles for attacker to prevent a peace without occupation
	capturing_defender_is_complete_victory = no # Capturing the defender as a prisoner is not considered an automatic victory for the attacker

	allow_distant = yes # Distant is calculated through the event that fires the CB

	allowed_to_target_tributaries = no

	on_add = {
		ROOT = {
			spawn_unit = {
				owner = THIS
				province = capital_scope
				home = capital_scope
				
				match_character = FROM
				match_mult = 1.0
				
				troops = {
					knights = { 500 500 }
					archers = { 500 500 }
					light_cavalry = { 500 500 }
					light_infantry = { 2500 2500 }
					heavy_infantry = { 1000 1000 }
				}
			
				#attrition = 1.0
				disband_on_peace = yes
			}
		}
		ROOT = { character_event = { id = MP.108 } }
	}
	
	can_use = {
		OR = {
			ai = yes # AI checks are done via the event that triggers the war
			# Conditions for the player
			AND = {
				#is_tribal = yes
				NOT = { year = 800 } # The migration period ended around 800
				ROOT = {
					OR = {
						religion = tengri_pagan
						religion = slavic_pagan
						religion = germanic_pagan
						culture = alan
					}
					NOT = { has_character_modifier = launched_migration_war }
					NOT = { tier = EMPEROR } # No Emperors
					#NOT = { higher_tier_than = KING } # No Emperors
					NOT = { culture = FROM }
					independent = yes # No vassals
					war = no # Ensures that the events activate correctly  
				}
				FROM = {
					independent = yes
					war = no
				}
			}
		}
		ROOT = { NOT = { has_character_flag = migration_cooldown } }
	}

	can_use_title = {
	}
	
	is_valid_title = {
	}
	
	on_success = {
		FROM = {  # Up to three bordering provinces that are occupied become the attackers religion and culture
			random_realm_province = {
				limit = {
					controlled_by = ROOT
				}
				culture = ROOT
				religion = ROOT
			}
			random_realm_province = {
				limit = {
					any_neighbor_province = {
						culture = ROOT 
						religion = ROOT
					}
					OR = {
						NOT = { religion = ROOT }
						NOT = { culture = ROOT }
					}
					controlled_by = ROOT
				}
				culture = ROOT
				religion = ROOT
			}
			random_realm_province = {
 				limit = {
					any_neighbor_province = {
						culture = ROOT 
						religion = ROOT
					}
					OR = {
						NOT = { religion = ROOT }
						NOT = { culture = ROOT }
					}
					controlled_by = ROOT
				}
				culture = ROOT
				religion = ROOT
			}
		}
		if = {
		    limit = { ROOT = { ai = yes } }
            FROM = {
                capital_scope = {
                    duchy = {
                        any_de_jure_vassal_title = {
                            limit = { 
                                holder_scope = {
                                    OR = {
                                        character = ROOT_FROM
                                        is_vassal_or_below_of = ROOT_FROM
                                    }
                                }
                            }
                            usurp_title = ROOT
                        }
                    }
                }
            }
		}
		ROOT = {
			set_character_flag = migration_cooldown
            any_vassal = {
                set_defacto_liege = THIS
                set_truce = {
                    who = ROOT
                    days = 5475
                }            
                
                ROOT = {
                    set_truce = {
                        who = PREV
                        days = 5475
                    }
                }
            }
			occupy_minors_of_occupied_settlements = FROM
			gain_all_occupied_titles = { who = FROM type = invasion }
			hidden_tooltip = {
				if = {
				    limit = {
					    ai = yes
					    is_tribal = yes
					}
				    any_realm_province = {
				        limit = { 
				    	    has_empty_holding = yes
				    	    has_tribal = no
				    	}
				        build_holding = {
                            type = tribal
                        }
				    	random_province_holding = { 
				    	    limit = { holding_type = tribal } 
				    		make_capital_holding = yes 
				    	}
				    }
				}
			}
			character_event = { id = MP.109 }
            if = {
                limit = { is_nomadic = yes }
                if = {
				    limit = { has_religion_feature = religion_feature_wonderer }
				    add_population_scaled = 0.50
					population = 3000
				}
				else = {
				    add_population_scaled = 0.25
					population = 1500					
				}
            }
            any_tributary = { remove_tributary = PREV }
		}
	}

	on_invalidation = {
		ROOT = {
			show_scope_change = no
			piety = 100
		}
	}

	on_fail = {
		ROOT = { prestige = -50 }
	}
	
	on_reverse_demand = {
		ROOT = {
			prestige = -1000
			add_character_modifier = {
				name = coallition_expelled
				years = 1
			}
			transfer_scaled_wealth = {
				to = FROM
				value = 3
				min = 1000
				max = 5000
			}
		}
		FROM = {
			prestige = 1000
			#disband_event_forces = yes
			#character_event = { id = MP.050 }
		}
	}
	
	on_attacker_leader_death = { end_war = invalid } 

	attacker_ai_victory_worth = { factor = -1 }
	attacker_ai_defeat_worth = { factor = 100 } 
	defender_ai_victory_worth = { factor = -1 }
	defender_ai_defeat_worth = { factor = 100 }
	
	ai_will_do = {
		factor = 0
		
		#modifier = {
		#	factor = 100
		#}
	}
}